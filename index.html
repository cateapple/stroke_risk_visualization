<html>
    <head>
        <meta charset="UTF-8">
        <title>Stroke risk factor visualizations</title>
        <link rel="stylesheet" type="text/css" href="style.css">
        <script src="https:d3js.org/d3.v6.min.js"></script>
    </head>
    <body>
        <h1>Prevalence of strokes for some risk factors</h1>
        <h3>Catherine Appleby (caa96), Esuvat Bomani (ekb72), Mia Bravo (mvb43)</h3>

        <p></p>
            <svg id="lifefactors" height="750" width="1000"></svg>

            <script>

            const svg = d3.select("svg#lifefactors");

            const width = svg.attr("width");
            const height = svg.attr("height");
            const margins = {"top": 50, "right": 20, "bottom": 100, "left": 150};

            const chartWidth = width - margins.left - margins.right;
            const chartHeight = height - margins.top - margins.bottom;

            let annotated = svg.append("g");
            let chartArea = svg.append("g")
                            .attr("transform","translate("+margins.left+","+margins.top+")");

            var lifedata;
            //promise function for life_factors
            d3.json("life_factors.json", d3.autoType).then((data) => {

                //conditional color scales - 3 main categories -
                function colorGiver(d){
                    let cat = String(d.category).charAt(0);
                    let sub = String(d.subcategory).charAt(0);
                    let intensity = {P: .2, S: .4, G: .6, c: .8, N: .8, Y: 0.5, U: 0.5, R: .8}
                    if(cat == "R"){
                        return d3.interpolateGreens(intensity[sub]);
                    }else if(cat == "e"){
                        return d3.interpolateBlues(intensity[sub]);
                    }else{
                        return d3.interpolatePurples(intensity[sub]);
                    }

                }

                //labels for graph
                function labelGraph(){

                    svg.append("text")
                        .text("Life Factors")
                        .attr("transform", `rotate(270,50,${height/2})`)
                        .attr("text-anchor", "middle")
                        .attr("x", 50)
                        .attr("y", height/2-5)

                    svg.append("text")
                        .text("Percentage of Strokes")
                        .attr("x", width/2)
                        .attr("y", 700)
                    
                    svg.append("text")
                        .text("Residence type")
                        .attr("fill", "grey")
                        .attr("transform", "rotate(-90, 20, 50)")
                        .attr("x", -570)
                        .attr("y", 100)
                    
                    svg.append("text")
                        .text("Ever Married?")
                        .attr("fill", "grey")
                        .attr("transform", "rotate(-90, 20, 50)")
                        .attr("x", -430)
                        .attr("y", 100)

                    svg.append("text")
                        .text("Occupation")
                        .attr("fill", "grey")
                        .attr("transform", "rotate(-90, 20, 50)")
                        .attr("x", -180)
                        .attr("y", 100)

                    svg.append("line")
                        .attr("x1", margins.left-88)
                        .attr("x2", margins.left)
                        .attr("y1", yScale("Rural")+margins.top)
                        .attr("y2", yScale("Rural")+margins.top)
                        .attr("stroke", "black")

                    svg.append("line")
                        .attr("x1", margins.left-90)
                        .attr("x2", margins.left)
                        .attr("y1", yScale("No")+margins.top)
                        .attr("y2", yScale("No")+margins.top)
                        .attr("stroke", "black")
                }


                //Make bar scales
                // x is stroke or not - 0 or 1
                //y scale is the number of bars we're making evenly distributed over the area of the chart in groups by category

                let Lgroups = Array.from(new Set(Object.values(data).map(d => d.category)));
                let Lsubgroups = Array.from(new Set(Object.values(data).map(d => d.subcategory)));

                let xScale = d3.scaleLinear().domain([0,5]).range([0, chartWidth]);
                let yScale = d3.scaleBand().domain(Lsubgroups).range([chartHeight, 0]).padding([0.03]);
                //let ySubgroupL = d3.scaleBand().domain(Lsubgroups)
                                //  .range([0, yScale.bandwidth()])
                                //.padding([0.01]);

                //make left axis and ticks
                let leftAxis = d3.axisLeft(yScale)
                    .tickFormat( tick => tick.charAt(0).toUpperCase() + tick.slice(1).replace(/_/g, " "));

                annotated.append("g").attr("class", "y axis")
                                        .attr("transform", "translate("+(margins.left-5)+","+(margins.top)+")")
                                        .call(leftAxis);


                //make bottom axis and ticks
                let bottomAxis = d3.axisBottom(xScale);
                let bottomGridLines = d3.axisBottom(xScale).tickFormat("").tickSize(-chartHeight);
                annotated.append("g").attr("class", "x axis")
                                        .attr("transform", "translate("+(margins.left)+","+(margins.top + chartHeight)+")")
                                        .call(bottomAxis);
                annotated.append("g").attr("class", "x gridlines")
                                        .attr("transform", "translate("+(margins.left)+","+(margins.top + chartHeight)+")")
                                        .call(bottomGridLines);

                //put bars onto graph and label them
                Object.values(data).forEach(d => {
                    
                    chartArea.append("rect")
                            .attr("x", xScale(0))
                            .attr("y", yScale(d.subcategory))
                            .attr("width", xScale(d.percentage))
                            .attr("height", yScale.bandwidth())
                            .attr("fill", colorGiver(d));

                    svg.append("text")
                            .text(d.percentage.toFixed(2)+"%")
                            .attr("x", margins.left+10)
                            .attr("y", yScale(d.subcategory)+margins.top+yScale.bandwidth()/2+5)
                            .attr("fill", "black");
                });

                labelGraph();

            });

            </script>

          <svg id="healthfactors" height="750" width="1000"></svg>
          <script>
              //graph area for health factors graph
              const svghealth = d3.select("svg#healthfactors");

              const widthH = svghealth.attr("width");
              const heightH = svghealth.attr("height");

              const marginsH = {"top": 50, "right": 20, "bottom": 100, "left": 150};

              const chartWidthH = widthH - marginsH.left - marginsH.right;
              const chartHeightH = heightH - marginsH.top - marginsH.bottom;

              let annotations = svghealth.append("g");
              let chart = svghealth.append("g").attr("transform","translate("+marginsH.left+","+marginsH.top+")");

              d3.json("health_factors.json", d3.autoType).then((data) => {
                console.log(Object.values(data));

                let groups = Array.from(new Set(Object.values(data).map(d => d.risk_factor)));
                let subgroups = Array.from(new Set(Object.values(data).map(d => d.gender))).slice(0,2);

                let xScaleH = d3.scaleLinear().domain([0,20]).range([0, chartWidthH]);
                let yScaleH = d3.scaleBand().domain(groups).range([chartHeightH, 0]).padding([0.05]);
                let ySubgroup = d3.scaleBand()
                                  .domain(subgroups)
                                  .range([0, yScaleH.bandwidth()])
                                  .padding([0.03]);

                let bottomAxisH = d3.axisBottom(xScaleH);
                let bottomGridLinesH = d3.axisBottom(xScaleH).tickFormat("").tickSize(-chartHeightH);
                annotations.append("g").attr("class", "x axis")
                                       .attr("transform", "translate("+(marginsH.left)+","+(marginsH.top + chartHeightH)+")")
                                       .raise()
                                       .call(bottomAxisH);
                annotations.append("g").attr("class", "gridlines")
                                       .attr("transform", "translate("+(marginsH.left)+","+(marginsH.top + chartHeightH)+")")
                                       .call(bottomGridLinesH);

                let leftAxisH = d3.axisLeft(yScaleH).tickFormat( tick => tick.charAt(0).toUpperCase() + tick.slice(1).replace(/_/g, " "));
                annotations.append("g").attr("class", "y axis")
                                       .attr("transform", "translate("+(marginsH.left)+","+(marginsH.top) +")")
                                       .raise()
                                       .call(leftAxisH);

                const groupEnter = chart.selectAll("g").data(groups)
                     .enter()
                     .append("g")
                     .attr("transform", d => `translate(0, ${yScaleH(d)})`)
                     .selectAll("rect")
                     .data(d => Object.values(data).filter(e => e.risk_factor === d))
                     .enter()

                groupEnter.append("rect")
                     .lower()
                     .attr("x", xScaleH(0))
                     .attr("y", d => ySubgroup(d.gender))
                     .attr("width", d => xScaleH(d.percentage))
                     .attr("height", d => ySubgroup.bandwidth())
                     .attr("fill", d => {
                                   if(d.gender === "Male"){
                                     return d3.interpolateBlues(0.8);
                                   }
                                   if(d.gender === "Female"){
                                     return d3.interpolateReds(0.75);
                                   }
                                 }
                           )

                groupEnter.append("text")
                          .text(d => d.percentage.toFixed(2)+"%")
                          .attr("x", 10)
                          .attr("y", d => ySubgroup(d.gender) + ySubgroup.bandwidth()/2 + 7)
                          .attr("fill", "white")


                svghealth.append("text")
                         .text("Health Factors")
                         .attr("transform", `rotate(270,50,${heightH/2})`)
                         .attr("text-anchor", "middle")
                         .attr("x", 50)
                         .attr("y", heightH/2)

                svghealth.append("text")
                        .text("Percentage of Strokes")
                        .attr("x", widthH/2)
                        .attr("y", 700)

                svghealth.append("circle").attr("cx",900).attr("cy",80).attr("r", 8).style("fill", d3.interpolateBlues(0.8))
                svghealth.append("circle").attr("cx",900).attr("cy",110).attr("r", 8).style("fill", d3.interpolateReds(0.75))
                svghealth.append("text").attr("x", 920).attr("y", 85).text("Male").style("font-size", "15px").attr("alignment-baseline","middle")
                svghealth.append("text").attr("x", 920).attr("y", 115).text("Female").style("font-size", "15px").attr("alignment-baseline","middle")


              });
        </script>
    </body>
</html>
